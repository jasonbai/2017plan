---
title: "WineQualityReds Analysis"
author: "Jasonbai"
date: "2017.5.31"
output: html_document
---

<style>
a {color: #38C5FF;}
h3 {color: #FF6A02;}
h4 {color: #FF6A62;}
</style>

WineQualityReds Analysis by Jasonbai
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

rm(list = ls())
library(readr)
library(ggplot2)
library(gridExtra)
library(GGally)
library(RColorBrewer)
library("VIM")
```

```{r echo=FALSE, Load_the_Data}
# Load the Data
# df <- read_csv("~/Desktop/P4/wineQualityReds.csv")
df <- read_csv("D:/GitHub/2017plan/Udacity/DAND/P4/wineQualityReds.csv")
summary(df)
```

### 1.structure of dataset 数据说明
Title: Wine Quality ,This dataset is public available for research. 

> P. Cortez, A. Cerdeira, F. Almeida, T. Matos and J. Reis.
  Modeling wine preferences by data mining from physicochemical properties.
  In Decision Support Systems, Elsevier, 47(4):547-553. ISSN: 0167-9236.

> Available at: [@Elsevier] http://dx.doi.org/10.1016/j.dss.2009.05.016
                [Pre-press (pdf)] http://www3.dsi.uminho.pt/pcortez/winequality09.pdf
                [bib] http://www3.dsi.uminho.pt/pcortez/dss09.bib

   Created by: Paulo Cortez (Univ. Minho), Antonio Cerdeira, Fernando Almeida, Telmo Matos and Jose Reis (CVRVV) @ 2009

变量统计：共计12个变量
```{r}
dim(df)
ls(df)
```
#### 1.1 Attribute information: 变量值
>  1. fixed acidity (tartaric acid - g / dm^3)
   2. volatile acidity (acetic acid - g / dm^3)
   3. citric acid (g / dm^3)
   4. residual sugar (g / dm^3)
   5. chlorides (sodium chloride - g / dm^3
   6. free sulfur dioxide (mg / dm^3)
   7. total sulfur dioxide (mg / dm^3)
   8. density (g / cm^3)
   9. pH
   10. sulphates (potassium sulphate - g / dm3)
   11. alcohol (% by volume)
   Output variable (based on sensory data):
   12. quality (score between 0 and 10)
   
   
#### 1.2 Description of attributes:变量描述

其中体现红酒的酸、甜、咸、苦的成分归纳如下：  
酸：Fixed acidity（酒石酸）、Volatile acidity（醋酸） 、  Citric acid（柠檬酸）   甜：Residual sugar（糖分） 、alcohol（酒精） 
咸：chlorides（氯化钠）  
苦：Free sulfur dioxide（游离二氧化硫）、Total sulfur dioxide（总二氧化硫）、sulphates（硫酸钾）   

#### 1.3 变量反思
显示的变量只是红酒主要的基本成分，并没有微量成分，由葡萄酒的品尝原理我们知道，葡萄酒中的微量成分是香气和滋味成分中最主要的部分，这些成分数目极大而浓度极小。这可能对我们的分析会造成不利的影响，即体现红酒质量的自变量缺失了，某些甚至可能是重要的变量。

#### 1.4   基础数据处理， 缺失值观察
```{r}
matrixplot(df)
df=na.omit(df)
```
本次的数据比较规整，无需做大量的数据清洗，缺失值只有两个，做删除处理


### 2.Leading Questions

**1.**影响高品质葡萄酒的有效因素有哪些？
**2.**是什么原因导致葡萄酒的质量不合格?   
**3.**是否可以依据化学成分预测葡萄酒的质量？

### 3. 单因素分析 

#### 3.1 Quality
```{r}
ggplot(df,aes(df$quality))+geom_histogram()
summary(df$quality)
  
```
这批数据中，变量质量几乎是正态分布。最好的评分实际上是8，但是在直方图中占比特别少，3的评级也相当罕见。如果想要比较这些不同的群体，这些群体的规模太小可能是个问题。

```{r}
x <- subset(df, select = -c(quality))
aggregate(x,list(df$quality),median)
```

从上图观察，还是很难区对红酒品质的好坏，有较好的区分度观察，所以我计划新建一个变量，用于归类区分品质好坏。

```{r}
#构造等级变量
df$rating<-ifelse(df$quality<5,"bad",
                    ifelse(df$quality==5,"medium-low",
                           ifelse(df$quality==6,"medium",                                  ifelse(df$quality==7,"medium-high","good"))))    

df$rating<-factor(df$rating,levels=c(
  "bad","medium-low","medium","medium-high","good"
  ),ordered=T)

#观察新变量
table(df$rating) 
qplot(data=df,x=rating)
x <- subset(df, select = -c(quality,rating))
aggregate(x,list(df$rating),median)
```

这样看起来就好多了，能明显区隔品质。

#### 3.2 接着来观察酿酒制作中几个主要变量，alcohol，residual.sugar，density

```{r}
p1<-qplot(data=df,x=alcohol)
p2<-qplot(data=df,x=residual.sugar)
p3<-qplot(data=df,x=density)

grid.arrange(p1,p2,p3)
```

alcohol（酒精）的百分比从8到14，与高乙醇含量杀死酵母的背景知识一致，因此不能超过15%。
density（密度）大多数葡萄酒的密度低于水，因为乙醇比水密度更小。
residual.sugar （甜度）多数集中在2左右，从直方图无法得出更多的结论，因为整体数据较为集中。

```{r}
p1<-qplot(data=df,x=df$fixed.acidity)
p2<-qplot(data=df,x=df$volatile.acidity)
p3<-qplot(data=df,x=df$citric.acid)
p4<-qplot(data=df,x=df$pH)
grid.arrange(p1,p2,p3,p4,ncol=2)
```

PH值，fixed.acidity，volatile.acidity三个值，符合正态分布。citric.acid为非正态分布，大多数小于0.75

```{r}
p1<-qplot(data=df,x=free.sulfur.dioxide,binwidth=4)
p2<-qplot(data=df,x=total.sulfur.dioxide,binwidth=5)
p3<-qplot(data=df,x=sulphates,binwidth=0.01)
grid.arrange(p1,p2,p3)
```

sulphates（硫酸钾）符合正态分布，free.sulfur.dioxide与total.sulfur.dioxide非正态分布，free.sulfur.dioxide不超过40，total.sulfur.dioxide主要在100以内。


```{r}
p1<-qplot(data=df,x=chlorides,binwidth=0.001)

p2<-qplot(data=df,x=log10(chlorides),binwidth=0.01)
grid.arrange(p1,p2)
```

chlorides主要为集中在0.1，呈现正态分布。

### 4.Univariate Analysis

**What is the structure of your dataset?**  
1597个观察，12个变量，quality为因变量，其他为自变量，且都为数值型。
>  
其中体现红酒的酸、甜、咸、苦的成分归纳如下：  
* 酸：Fixed acidity（酒石酸）、Volatile acidity（醋酸） 、  Citric acid（柠檬酸）   
* 甜：Residual sugar（糖分） 、alcohol（酒精） 
* 咸：chlorides（氯化钠）  
* 苦：Free sulfur dioxide（游离二氧化硫）、Total sulfur dioxide（总二氧化硫）、sulphates（硫酸钾）   

**What is/are the main feature(s) of interest in your dataset?**  

在酿酒过程中，我主要感兴趣Residual sugar 和 alcohol

**What other features in the dataset do you think will help support your investigation into your feature(s) of interest?**  
volatile.acidity and free.sulfur.dioxide 是影响酒的重要因素。
除此之外还有fixed acidity,citric acidity也会影响口感;  
pH和density并不是很感兴趣。  

**Did you create any new variables from existing variables in the dataset?**  
是的，我生成了一个新的变量来排除异常值及数据过于分散的影响。

**Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?**  
除了alchohol,pH and quality(rating) 是正态分布的,其他的都为长尾分布。 

### 5.Bivariate Plots Section

#### 5.1 变量间相关性观察

```{r pairwise_corelation}
#compute the corelations between 12 variables 
require(corrplot)
mat<-as.matrix(subset(df,select=c(1:12)))
cor_mat<-cor(mat)
cor_mat
corrplot(cor_mat,tl.cex = 0.6)

#To look at it closely I display only correlation I am interested
#cor_mat<-ifelse((cor_mat<(-0.3) | cor_mat>0.3) & cor_mat!=1,cor_mat,NA)
#cor_mat

rm(mat,cor_mat)
```

可以看到Fixed acidity与density，Citric acid、PH 的相关系数在0.68左右。
Free sulfur dioxide与total.sulfur.dioxide，的相关系数在0.68左右。

其他变量之间的相关程度并不高。其中，Fixed acidity 与PH、Volatile acidity与Fixed acidity、alcohol与density之间存在负相关性。 综上也说明了，在葡萄酒的成分里，Fixed acidity和许多化学成分存在相关性。 

```{r pairwise_plot,fig.width=12,fig.height=8}
ggpairs(df)
```

从这幅图可以更加清晰的了解到变量之间的相关性特点，本来预期酒精alcohol对酒的影响很大，但实际从图表看，并没有特别的影响。

#### 5.2 Alcohol and Volatile.acidity 
```{r quality_alcohol}

ggplot(aes(x=quality,y=alcohol),data=df)+
  geom_jitter(alpha=1/5,color="Darkblue")+
  geom_quantile(stat="quantile",quantiles=c(0.25,0.5,0.75),color="red")
```

```{r rating_alcohol}
ggplot(aes(x=rating,y=alcohol,fill=rating),data=df)+
  geom_boxplot()

by(df$alcohol,df$rating,summary)
```


可以看到，酒精度和品质，在从bad到medium-low有下降，但是从medium-low开始，alcohol和rating有了明显的趋势。


```{r quality/rating_volatile.acidity}
p1<-ggplot(aes(x=quality,y=volatile.acidity),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.25),
            aes(group=1),size=1,linetype=2,color="red")+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5),
            aes(group=1),size=1,color="red")+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.75),
            aes(group=1),size=1,linetype=2,color="red")

p2<-ggplot(aes(x=rating,y=volatile.acidity,fill=rating),data=df)+
  geom_boxplot()+
  scale_fill_brewer(palette="Reds")+ 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

grid.arrange(p1,p2,ncol=2)

by(df$volatile.acidity,df$rating,summary)
```

可以看到随着quality的提升， volatile acidity也随之下降，但是在medium-high和good区间，volatile acidity变化变缓，随之接近。


#### 5.3 Chlorides and Quality 

```{r quality/rating_chlorides}

p1<-ggplot(aes(x=quality,y=chlorides),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.25),
            aes(group=1),size=1,linetype=2,color="red")+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5), 
            aes(group=1),size=1,color="red")+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.75),
            aes(group=1),size=1,linetype=2,color="red")

p2<-ggplot(aes(x=rating,y=chlorides,fill=rating),data=df)+
  geom_boxplot()+
  scale_fill_brewer(palette="Purples")+ 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

grid.arrange(p1,p2,ncol=2)

by(df$chlorides,df$rating,summary)
```
 Chlorides和rating看起来只有微乎其微的关系，随着chlorides增加，红酒的品质有微弱下降趋势。
 

##### 5.4  其他因素与Quality的关系
```{r quality_others}
p1<-ggplot(aes(x=quality,y=fixed.acidity),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5),
            aes(group=1),size=1,color="red")

p2<-ggplot(aes(x=quality,y=citric.acid),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5),
            aes(group=1),size=1,color="red")

p3<-ggplot(aes(x=quality,y=residual.sugar),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5),
            aes(group=1),size=1,color="red")

p4<-ggplot(aes(x=quality,y=free.sulfur.dioxide),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5),
            aes(group=1),size=1,color="red")

p5<-ggplot(aes(x=quality,y=total.sulfur.dioxide),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5),
            aes(group=1),size=1,color="red")

p6<-ggplot(aes(x=quality,y=sulphates),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5),
            aes(group=1),size=1,color="red")


grid.arrange(p1,p2,p3,p4,p5,p6,ncol=3)
```

As we can see from plots, there is no observable correlation from scatter plot aginst quality any more. Quality is almost homogenously distributed and symetric along y axis.  

从这张集合图可以看到，大多数变量和quality没有特别明显的趋势。


### 5.5 Density corelated  

```{r residual.sugar_density}
ggplot(aes(x=residual.sugar,y=density),data=df)+
  geom_point(alpha=1/5)+
  geom_smooth(method="lm",color="red")

```

```{r alchol_density}
ggplot(aes(x=alcohol,y=density),data=df)+
  scale_x_continuous(breaks=seq(8,15,1))+
  geom_point(alpha=1/5)+
  geom_smooth(method="lm",color="red")

```

除了quality外，我们还对density特别感兴趣，从了解的红酒知识，density与很多要素有相关性，从上图可以看到density与residual sugar有一定线性相关性。Alcohol与density也有明显的线性相关性。

除了以上两个变量， fixed.acidity,citric.acid, 和chlorides 与 density 的相关性分别为0.66,0.36,0.20 ，还有total.sulfur.dioxide，free.sulfur.dioxide两个变量，作图观察。


```{r}
p1<-ggplot(aes(x=total.sulfur.dioxide,y=density),data=df)+
  geom_point(alpha=1/5)+
  xlim(0,300)+
  ylim(0.98,1.01)+
  geom_smooth(method="lm",color="red")

p2<-ggplot(aes(x=free.sulfur.dioxide,y=density),data=df)+
  geom_point(alpha=1/5)+
  xlim(0,150)+
  ylim(0.98,1.01)+
  geom_smooth(method="lm",color="red")

grid.arrange(p1,p2)
```

可以看到两者没有太多相关性。

```{r total.sulfur.dioxide_free.sulfur.dioxide}

ggplot(aes(x=total.sulfur.dioxide,y=free.sulfur.dioxide),data=df)+
  geom_point(alpha=1/10)+
  geom_smooth(method="lm",color="red")
```

As free SO^2^ increases, total SO^2^ increases and scattered broadly. The whole distribution displays a fan shape.     
But even total SO^2^ is at most 300 mg/dm^3^. How can it impact so much on density?   
To solve the puzzle we need to link this piece of infomation with others. Here are some other suprising findings. 






















```{r}
ggplot(aes(x=quality,y=citric.acid),data=df)+
  geom_jitter(alpha=1/5)+
  geom_line(data=df,stat="summary",
            fun.y=quantile,fun.args=list(probs=0.5))

cor.test(df$quality,df$citric.acid)
```


2










































#### 2.3 自变量间的相关性分析
```{r}

ggplot(df,aes(factor(df$fixed.acidity), df$citric.acid))  +
  geom_boxplot( alpha = .5,color = 'blue')+
  stat_summary(fun.y = "mean", 
               geom = "point", 
               color = "red")


ggplot(df,aes(factor(df$fixed.acidity), df$density))  +
  geom_boxplot( alpha = .5,color = 'blue')+
  stat_summary(fun.y = "mean", 
               geom = "point", 
               color = "red")

ggplot(df,aes(factor(df$fixed.acidity), df$pH))  +
  geom_boxplot( alpha = .5,color = 'blue')+
  stat_summary(fun.y = "mean", 
               geom = "point", 
               color = "red")

ggplot(df,aes(factor(df$volatile.acidity), df$citric.acid))  +
  geom_boxplot( alpha = .5,color = 'blue')+
  stat_summary(fun.y = "mean", 
               geom = "point", 
               color = "red")

ggplot(df,aes(factor(df$citric.acid), df$pH))  +
  geom_boxplot( alpha = .5,color = 'blue')+
  stat_summary(fun.y = "mean", 
               geom = "point", 
               color = "red")

ggplot(df,aes(factor(df$free.sulfur.dioxide), df$total.sulfur.dioxide))  +
  geom_boxplot( alpha = .5,color = 'blue')+
  stat_summary(fun.y = "mean", 
               geom = "point", 
               color = "red")

ggplot(df,aes(factor(df$free.sulfur.dioxide), df$total.sulfur.dioxide))  +
  geom_boxplot( alpha = .5,color = 'blue')+
  stat_summary(fun.y = "mean", 
               geom = "point", 
               color = "red")

ggplot(df,aes(factor(df$density), df$alcohol))  +
  geom_boxplot( alpha = .5,color = 'blue')+
  stat_summary(fun.y = "mean", 
               geom = "point", 
               color = "red")
```

#### 2.4 进一步分析

```{r}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
usr <- par("usr"); on.exit(par(usr))
par(usr = c(0, 1, 0, 1))
r <- abs(cor(x, y))
txt <- format(c(r, 0.123456789), digits = digits)[1]
txt <- paste0(prefix, txt)
if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
text(0.5, 0.5, txt, cex = cex.cor * r)
}
panel.hist <- function(x, ...)
{
usr <- par("usr"); on.exit(par(usr))
par(usr = c(usr[1:2], 0, 1.5) )
h <- hist(x, plot = FALSE)
breaks <- h$breaks; nB <- length(breaks)
y <- h$counts; y <- y/max(y)
rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}
pairs(df, 
lower.panel=panel.cor,
upper.panel=panel.smooth,
diag.panel=panel.hist,
main = 'The Scatterplot Matrix of The WineQualityReds',
pch = 21,
bg = "orange",
line.main=1.5,
oma=c(2,2,3,2)
)
```

可以得出：
除了Fixed acidity与density，Fixed acidity与Citric  acid、Fixed acidity与PH、Free sulfur dioxide与otal sulfur dioxide的相关系数在0.68左右，其他变量之间的相关程度并不高。其中，Fixed acidity 与PH、Volatile acidity与Fixed acidity、alcohol与density之间存在负相关性。 综上也说明了，在葡萄酒的成分里，Fixed acidity和许多化学成分存在相关性。 

### 3.模型建立
#### 3.1 建立训练集与验证集
挑选线性关系较强的变量入模，反复调整后，确定入模变量表现最强。
```{r}
library(memisc)
m1 <- lm(df$quality ~ df$volatile.acidity,data=df)
m2 <- update(m1,~.+ df$chlorides)
m3 <- update(m2,~.+ df$total.sulfur.dioxide)
m4 <- update(m3,~.+ df$pH)
m5 <- update(m4,~.+ df$sulphates)
m6 <- update(m5,~.+ df$alcohol)
mtable(m1,m2,m3,m4,m5,m6)

```

#### 3.2 模型诊断
```{r}
plot(m6)
```

> 
* 1图 散点规律不是特别明显，线性关系一般。
* 2图 散点大致都集中在QQ图中的直线上，说明残差正态性良好。
* 3图 点在曲线周围随机分布，残差方差基本不变
* 4图 残差间相关独立检测。

### 4.模型验证

#### 4.1 通过成分残差图即偏残差图，判断因变量与自变量之间是否呈非线性关系
从生成的图像来说，因变量和各个自变量的线性关系相对明显，模型效果相对成功。
```{r}
library(car)
crPlots(m6)
```

### 5.反思
    前面也提过本数据集，变量只是红酒主要的基本成分，并没有微量成分，由葡萄酒的品尝原理我们知道，葡萄酒中的微量成分是香气和滋味成分中最主要的部分，这些成分数目极大而浓度极小。这可能对我们的分析会造成不利的影响，即体现红酒质量的自变量缺失了，某些甚至可能是重要的变量。
    而且在数据量上，由于本数据样本较小，且红酒品质多数集中5，6级的评级，且分布较为平均，不是能很好的分析出影响一瓶好红酒有哪些因素。
    其次建模方法上，我先观察了变量之间的线性关系，挑选了线性关系较强的变量，从多元线性建立模型，反复调整后，最终选择了表现最强的变量入模。
    经过模型验证，说明模型效果。
    但是模型效果的好坏的决定因素是变量，变量的有效性，数据量都先天决定了模型的效果，和将来的实际应用。今后应该进一步去收集很多的变量及数据量，将对模型的建立有良好的促进效果。

 





